{"version":3,"file":"provider.js","sourceRoot":"","sources":["provider.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ReactiveController, ReactiveElement } from 'lit';\nimport type { Context, ContextCallback, ContextEvent, UnknownContext } from '../event.js';\n\nimport {\n  contextEvents,\n  ColorContextController,\n  type ColorContextOptions,\n} from './controller.js';\n\nimport { ColorContextConsumer, type ColorTheme } from './consumer.js';\n\nimport { Logger } from '@patternfly/pfe-core/controllers/logger.js';\n\n/**\n * A `ColorPalette` is a collection of specific color values\n * Choosing a palette sets both color properties and, if the component is a context provider,\n * implies a color theme for descendents.\n *\n * `ColorPalette` is associated with the `color-palette` attribute\n */\nexport type ColorPalette = (\n  | 'base'\n  | 'accent'\n  | 'complement'\n  | 'lighter'\n  | 'lightest'\n  | 'dark'\n  | 'darker'\n  | 'darkest'\n);\n\nexport interface ColorContextProviderOptions<T extends ReactiveElement> extends ColorContextOptions<T> {\n  /** Attribute to set context. Providers only */\n  attribute?: string;\n}\n\n/**\n * `ColorContextProvider` is responsible to derive a context value from CSS and provide it to its\n * descendents.\n */\nexport class ColorContextProvider<\n  T extends ReactiveElement\n> extends ColorContextController<T> implements ReactiveController {\n  static contexts = new Map(Object.entries({\n    darkest: 'dark' as const,\n    darker: 'dark' as const,\n    dark: 'dark' as const,\n    light: 'light' as const,\n    lighter: 'light' as const,\n    lightest: 'light' as const,\n  }));\n\n  #attribute: string;\n\n  /** Cache of context callbacks. Call each to update consumers */\n  #callbacks = new Set<ContextCallback<ColorTheme|null>>();\n\n  /** Mutation observer which updates consumers when `color-palette` attribute change. */\n  #mo = new MutationObserver(() => this.update());\n\n  /**\n   * Cached (live) computed style declaration\n   * @see https://developer.mozilla.org/en-US/docs/Web/API/Window/getComputedStyle\n   */\n  #style: CSSStyleDeclaration;\n\n  #initialized = false;\n\n  #logger: Logger;\n\n  #consumer: ColorContextConsumer<T>;\n\n  get local() {\n    return this.#local;\n  }\n\n  get #local() {\n    return ColorContextProvider\n      .contexts.get(this.host.getAttribute(this.#attribute) ?? '');\n  }\n\n  get value(): ColorTheme {\n    return this.#local ?? this.#consumer.value;\n  }\n\n  constructor(host: T, options?: ColorContextProviderOptions<T>) {\n    const { attribute = 'color-palette', ...rest } = options ?? {};\n    super(host, rest);\n    this.#consumer = new ColorContextConsumer(host, { callback: value => this.update(value) });\n    this.#logger = new Logger(host);\n    this.#style = window.getComputedStyle(host);\n    this.#attribute = attribute;\n    if (this.#attribute !== 'color-palette') {\n      this.#logger.warn('color context currently supports the `color-palette` attribute only.');\n    }\n  }\n\n  /**\n     * When a context provider connects, it listens for context-request events\n     * it also fires all previously fired context-request events from their hosts,\n     * in case this context provider upgraded after and is closer to a given consumer.\n     */\n  async hostConnected() {\n    this.host.addEventListener('context-request', e => this.#onChildContextEvent(e));\n    this.#mo.observe(this.host, { attributes: true, attributeFilter: [this.#attribute] });\n    for (const [host, fired] of contextEvents) {\n      host.dispatchEvent(fired);\n    }\n    await this.host.updateComplete;\n    this.update();\n  }\n\n  hostUpdated() {\n    this.#initialized ||= (this.update(), true);\n    if (this.#local && this.value !== this.#consumer.value) {\n      this.#consumer.update(this.#local);\n      this.update();\n    }\n  }\n\n  /**\n   * When a context provider disconnects, it disconnects its mutation observer\n   */\n  hostDisconnected() {\n    this.#callbacks.forEach(x => this.#callbacks.delete(x));\n    this.#mo.disconnect();\n  }\n\n  /** Was the context event fired requesting our colour-context context? */\n  #isColorContextEvent(\n    event: ContextEvent<UnknownContext>\n  ): event is ContextEvent<Context<ColorTheme|null>> {\n    return (\n      event.target !== this.host &&\n        event.context.name === `${this.prefix}-color-context`\n    );\n  }\n\n  /**\n   * Provider part of context API\n   * When a child connects, claim its context-request event\n   * and add its callback to the Set of children if it requests multiple updates\n   */\n  async #onChildContextEvent(event: ContextEvent<UnknownContext>) {\n    // only handle ContextEvents relevant to colour context\n    if (this.#isColorContextEvent(event)) {\n      // claim the context-request event for ourselves (required by context protocol)\n      event.stopPropagation();\n\n      // Run the callback to initialize the child's colour-context\n      event.callback(this.value);\n\n      // Cache the callback for future updates, if requested\n      if (event.multiple) {\n        this.#callbacks.add(event.callback);\n      }\n    }\n  }\n\n  /** Calls the context callback for all consumers */\n  public override async update(force?: ColorTheme) {\n    const { value } = this;\n\n    for (const cb of this.#callbacks) {\n      cb(force ?? value);\n    }\n  }\n}\n\n/** Makes this element a color context provider which updates its consumers when the decorated field changes */\nexport function colorContextProvider<T extends ReactiveElement>(options?: ColorContextOptions<T>) {\n  return function(proto: T, _propertyName: string) {\n    const propertyName = _propertyName as keyof T;\n    const klass = (proto.constructor as typeof ReactiveElement);\n    const propOpts = klass.getPropertyOptions(_propertyName);\n    const attribute = typeof propOpts.attribute === 'boolean' ? undefined : propOpts.attribute;\n    klass.addInitializer(instance => {\n      const controller = new ColorContextProvider(instance as T, { propertyName, attribute, ...options });\n      // @ts-expect-error: this assignment is strictly for debugging purposes\n      instance.__DEBUG_colorContextProvider = controller;\n    });\n  };\n}\n"]}