{"version":3,"file":"consumer.js","sourceRoot":"","sources":["consumer.ts"],"names":[],"mappings":"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","sourcesContent":["import { isServer, type ReactiveController, type ReactiveElement } from 'lit';\n\nimport {\n  contextEvents,\n  ColorContextController,\n  type ColorContextOptions,\n} from './controller.js';\n\nimport { ContextRequestEvent } from '../event.js';\n\nimport styles from '@rhds/tokens/css/color-context-consumer.css.js';\n\n/**\n   * A Color theme is a context-specific restriction on the available color palettes\n   *\n   * `ColorTheme` is associated with the `on` attribute and the `--context` css property\n   */\nexport type ColorTheme = (\n  | 'dark'\n  | 'light'\n  | 'saturated'\n);\n\ninterface ColorContextConsumerOptions<T extends ReactiveElement> extends ColorContextOptions<T> {\n  /** Private callback for instances where a consumer is also a provider. */\n  callback?: (value: ColorTheme) => void;\n}\n\n/**\n * A color context consumer receives sets it's context property based on the context provided\n * by the closest color context provider.\n * The consumer has no direct access to the context, it must receive it from the provider.\n */\nexport class ColorContextConsumer<\n  T extends ReactiveElement\n> extends ColorContextController<T> implements ReactiveController {\n  #propertyName: keyof T;\n\n  get #propertyValue() {\n    return this.host[this.#propertyName] as ColorTheme;\n  }\n\n  set #propertyValue(x) {\n    this.host[this.#propertyName] = x as T[keyof T];\n    this.host.requestUpdate();\n  }\n\n  get value() {\n    return this.#propertyValue;\n  }\n\n  #dispose?: () => void;\n\n  #override: ColorTheme | null = null;\n\n  constructor(host: T, private options?: ColorContextConsumerOptions<T>) {\n    super(host, styles);\n    this.#propertyName = options?.propertyName ?? 'on' as keyof T;\n  }\n\n  /** When a consumer connects, it requests colour context from the closest provider. */\n  async hostConnected() {\n    const { context } = ColorContextController;\n    const event = new ContextRequestEvent(context, e => this.#contextCallback(e), true);\n    this.#override = this.#propertyValue;\n    contextEvents.set(this.host, event);\n    await this.host.updateComplete;\n    this.host.dispatchEvent(event);\n    this.#override = null;\n  }\n\n  hostUpdated() {\n    if (!isServer && !this.host.hasUpdated) {\n      // This is definitely overkill, but it's the only\n      // way we've found so far to work around lit-ssr hydration woes\n      this.hostConnected();\n    }\n  }\n\n  /** When a consumer disconnects, it's removed from the list of consumers. */\n  hostDisconnected() {\n    this.#dispose?.();\n    this.#dispose = undefined;\n    contextEvents.delete(this.host);\n  }\n\n  /**\n   * Register the dispose callback for hosts that requested multiple updates,\n   * then update the colour-context\n   * @param value the color theme\n   * @param dispose cleanup callback\n   */\n  #contextCallback(value: ColorTheme | null, dispose?: () => void) {\n    // protect against changing providers\n    if (dispose && dispose !== this.#dispose) {\n      this.#dispose?.();\n      this.#dispose = dispose;\n    }\n    this.update(value);\n  }\n\n  /**\n   * Sets the `on` attribute on the host and any children that requested multiple updates\n   * @param next the color theme\n   */\n  public update(next: ColorTheme | null) {\n    const { last } = this;\n    if (!this.#override && next !== last) {\n      this.last = next;\n      this.#propertyValue = (next ?? undefined) as ColorTheme;\n    }\n    this.options?.callback?.(this.#propertyValue);\n  }\n}\n\n/**\n * Makes this element a color context consumer\n * @param options options\n */\nexport function colorContextConsumer<\n  T extends ReactiveElement\n>(options?: ColorContextOptions<T>) {\n  return function(proto: T, _propertyName: string | keyof T) {\n    const propertyName = _propertyName as keyof T;\n    (proto.constructor as typeof ReactiveElement).addInitializer(instance => {\n      const controller = new ColorContextConsumer(instance as T, { propertyName, ...options });\n      // @ts-expect-error: this assignment is strictly for debugging purposes\n      instance.__DEBUG_colorContextConsumer = controller;\n    });\n  };\n}\n"]}