{"version":3,"file":"at-focus-controller.js","sourceRoot":"","sources":["at-focus-controller.ts"],"names":[],"mappings":"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","sourcesContent":["import { isServer, type ReactiveControllerHost } from 'lit';\nimport { bound } from '../decorators/bound.js';\n\nfunction isATFocusableItem(el: Element): el is HTMLElement {\n  return !!el\n      && el.ariaHidden !== 'true'\n      && !el.hasAttribute('inert')\n      && !el.hasAttribute('hidden');\n}\n\nexport interface ATFocusControllerOptions<Item extends HTMLElement> {\n  /**\n   * Callback to return the list of items\n   */\n  getItems(): Item[];\n  /**\n   * Callback to return the listbox container element\n   */\n  getItemsContainer?(): HTMLElement | null;\n  /**\n   * Callback to return the direction of navigation in the list box.\n   */\n  getOrientation?(): 'horizontal' | 'vertical' | 'both' | 'undefined';\n  /**\n   * Function returning the DOM nodes which are accessibility controllers of item container\n   * e.g. the button toggle and combobox input which control a listbox.\n   */\n  getControlsElements?(): HTMLElement[];\n}\n\nexport abstract class ATFocusController<Item extends HTMLElement> {\n  #itemsContainerElement: HTMLElement | null = null;\n\n  #atFocusedItemIndex = -1;\n\n  protected _items: Item[] = [];\n\n  /** All items */\n  abstract items: Item[];\n\n  /**\n   * Index of the Item which currently has assistive technology focus\n   * Set this to change focus. Setting to an out-of-bounds value will\n   * wrap around to the other side of the list.\n   */\n  get atFocusedItemIndex() {\n    return this.#atFocusedItemIndex;\n  }\n\n  set atFocusedItemIndex(index: number) {\n    const previousIndex = this.#atFocusedItemIndex;\n    const direction = index > previousIndex ? 1 : -1;\n    const { items, atFocusableItems } = this;\n    const itemsIndexOfLastATFocusableItem = items.indexOf(this.atFocusableItems.at(-1)!);\n    let itemToGainFocus = items.at(index);\n    let itemToGainFocusIsFocusable = atFocusableItems.includes(itemToGainFocus!);\n    if (atFocusableItems.length) {\n      let count = 0;\n      while (!itemToGainFocus || !itemToGainFocusIsFocusable && count++ <= 1000) {\n        if (index < 0) {\n          index = itemsIndexOfLastATFocusableItem;\n        } else if (index >= itemsIndexOfLastATFocusableItem) {\n          index = 0;\n        } else {\n          index = index + direction;\n        }\n        itemToGainFocus = items.at(index);\n        itemToGainFocusIsFocusable = atFocusableItems.includes(itemToGainFocus!);\n      }\n      if (count >= 1000) {\n        throw new Error('Could not atFocusedItemIndex');\n      }\n    }\n    this.#atFocusedItemIndex = index;\n  }\n\n  /** Elements which control the items container e.g. a combobox input */\n  protected get controlsElements(): HTMLElement[] {\n    return this.options.getControlsElements?.() ?? [];\n  }\n\n  /** All items which are able to receive assistive technology focus */\n  get atFocusableItems(): Item[] {\n    return this._items.filter(isATFocusableItem);\n  }\n\n  /** The element containing focusable items, e.g. a listbox */\n  get itemsContainerElement() {\n    return this.#itemsContainerElement ?? null;\n  }\n\n  set itemsContainerElement(container: HTMLElement | null) {\n    if (container !== this.#itemsContainerElement) {\n      this.#itemsContainerElement?.removeEventListener('keydown', this.onKeydown);\n      this.#itemsContainerElement = container;\n      this.#itemsContainerElement?.addEventListener('keydown', this.onKeydown);\n      this.host.requestUpdate();\n    }\n  }\n\n  constructor(\n    public host: ReactiveControllerHost,\n    protected options: ATFocusControllerOptions<Item>,\n  ) {\n    this.host.updateComplete.then(() => this.initItems());\n  }\n\n  /**\n   * Initialize the items and itemsContainerElement fields\n   */\n  protected initItems(): void {\n    this.items = this.options.getItems();\n    this.itemsContainerElement ??= this.#initContainer();\n  }\n\n  hostConnected(): void {\n    this.hostUpdate();\n  }\n\n  hostDisconnected(): void {\n    this.#itemsContainerElement?.removeEventListener('keydown', this.onKeydown);\n  }\n\n  hostUpdate(): void {\n    this.itemsContainerElement ??= this.#initContainer();\n  }\n\n  #initContainer() {\n    return this.options.getItemsContainer?.()\n      ?? (!isServer && this.host instanceof HTMLElement ? this.host : null);\n  }\n\n  /**\n   * Override and conditionally call `super.onKeydown` to filter out keyboard events\n   * which should not result in a focus change. Ensure that subclass' method is bound\n   * @param event keyboard event\n   */\n  protected onKeydown(event: KeyboardEvent): void {\n    const orientation = this.options.getOrientation?.() ?? this\n        .#itemsContainerElement\n        ?.getAttribute('aria-orientation') as\n            'horizontal' | 'vertical' | 'grid' | 'undefined';\n\n    const item = this._items.at(this.atFocusedItemIndex);\n\n    const horizontalOnly =\n        orientation === 'horizontal'\n        || item?.tagName === 'SELECT'\n        || item?.getAttribute('role') === 'spinbutton';\n\n    const verticalOnly = orientation === 'vertical';\n\n    switch (event.key) {\n      case 'ArrowLeft':\n        if (verticalOnly) {\n          return;\n        }\n        this.atFocusedItemIndex--;\n        event.stopPropagation();\n        event.preventDefault();\n        break;\n      case 'ArrowRight':\n        if (verticalOnly) {\n          return;\n        }\n        this.atFocusedItemIndex++;\n        event.stopPropagation();\n        event.preventDefault();\n        break;\n      case 'ArrowUp':\n        if (horizontalOnly) {\n          return;\n        }\n        this.atFocusedItemIndex--;\n        event.stopPropagation();\n        event.preventDefault();\n        break;\n      case 'ArrowDown':\n        if (horizontalOnly) {\n          return;\n        }\n        this.atFocusedItemIndex++;\n        event.stopPropagation();\n        event.preventDefault();\n        break;\n      case 'Home':\n        if (!(event.target instanceof HTMLElement\n            && (event.target.hasAttribute('aria-activedescendant')\n             || event.target.ariaActiveDescendantElement))) {\n          this.atFocusedItemIndex = 0;\n          event.stopPropagation();\n          event.preventDefault();\n        }\n        break;\n      case 'End':\n        if (!(event.target instanceof HTMLElement\n            && (event.target.hasAttribute('aria-activedescendant')\n             || event.target.ariaActiveDescendantElement))) {\n          this.atFocusedItemIndex = this.items.length - 1;\n          event.stopPropagation();\n          event.preventDefault();\n        }\n        break;\n      default:\n        break;\n    }\n    this.host.requestUpdate();\n  };\n}\n"]}