{"version":3,"file":"lit-element-hydrate-support.js","sources":["../../src/lit-element-hydrate-support.ts"],"sourcesContent":["/**\n * @license\n * Copyright 2017 Google LLC\n * SPDX-License-Identifier: BSD-3-Clause\n */\n\n/**\n * LitElement support for hydration of content rendered using lit-ssr.\n *\n * @packageDocumentation\n */\n\nimport type {PropertyValues} from '@lit/reactive-element';\nimport {render, RenderOptions} from 'lit-html';\nimport {hydrate} from './lib/hydrate-lit-html.js';\n\n// Keep consistent with `@lit-labs/ssr-dom-shim`\nconst HYDRATE_INTERNALS_ATTR_PREFIX = 'hydrate-internals-';\n\ninterface PatchableLitElement extends HTMLElement {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/no-misused-new\n  new (...args: any[]): PatchableLitElement;\n  enableUpdating(requestedUpdate?: boolean): void;\n  createRenderRoot(): Element | ShadowRoot;\n  renderRoot: HTMLElement | DocumentFragment;\n  render(): unknown;\n  renderOptions: RenderOptions;\n  _$needsHydration: boolean;\n}\n\nglobalThis.litElementHydrateSupport = ({\n  LitElement,\n}: {\n  LitElement: PatchableLitElement;\n}) => {\n  const observedAttributes = Object.getOwnPropertyDescriptor(\n    Object.getPrototypeOf(LitElement),\n    'observedAttributes'\n  )!.get!;\n\n  // Add `defer-hydration` to observedAttributes\n  Object.defineProperty(LitElement, 'observedAttributes', {\n    get() {\n      return [...observedAttributes.call(this), 'defer-hydration'];\n    },\n  });\n\n  // Enable element when 'defer-hydration' attribute is removed by calling the\n  // super.connectedCallback()\n  const attributeChangedCallback =\n    LitElement.prototype.attributeChangedCallback;\n  LitElement.prototype.attributeChangedCallback = function (\n    name: string,\n    old: string | null,\n    value: string | null\n  ) {\n    if (name === 'defer-hydration' && value === null) {\n      connectedCallback.call(this);\n    }\n    attributeChangedCallback.call(this, name, old, value);\n  };\n\n  // Override `connectedCallback` to capture whether we need hydration, and\n  // defer `super.connectedCallback()` if the 'defer-hydration' attribute is set\n  const connectedCallback = LitElement.prototype.connectedCallback;\n  LitElement.prototype.connectedCallback = function (\n    this: PatchableLitElement\n  ) {\n    // If the outer scope of this element has not yet been hydrated, wait until\n    // 'defer-hydration' attribute has been removed to enable\n    if (!this.hasAttribute('defer-hydration')) {\n      connectedCallback.call(this);\n    }\n  };\n\n  // If we've been server-side rendered, just return `this.shadowRoot`, don't\n  // call the base implementation, which would also adopt styles (for now)\n  const createRenderRoot = LitElement.prototype.createRenderRoot;\n  LitElement.prototype.createRenderRoot = function (this: PatchableLitElement) {\n    if (this.shadowRoot) {\n      this._$needsHydration = true;\n      return this.shadowRoot;\n    } else {\n      return createRenderRoot.call(this);\n    }\n  };\n\n  // Hydrate on first update when needed\n  const update = Object.getPrototypeOf(LitElement.prototype).update;\n  LitElement.prototype.update = function (\n    this: PatchableLitElement,\n    changedProperties: PropertyValues\n  ) {\n    const value = this.render();\n    // Since this is a patch, we can't call super.update(), so we capture\n    // it off the proto chain and call it instead\n    update.call(this, changedProperties);\n    if (this._$needsHydration) {\n      this._$needsHydration = false;\n      // Remove aria attributes added by internals shim during SSR\n      for (const attrName of this.getAttributeNames()) {\n        if (attrName.startsWith(HYDRATE_INTERNALS_ATTR_PREFIX)) {\n          const ariaAttr = attrName.slice(HYDRATE_INTERNALS_ATTR_PREFIX.length);\n          this.removeAttribute(ariaAttr);\n          this.removeAttribute(attrName);\n        }\n      }\n      hydrate(value, this.renderRoot, this.renderOptions);\n    } else {\n      render(value, this.renderRoot, this.renderOptions);\n    }\n  };\n};\n"],"names":[],"mappings":";;;AAAA;;;;AAIG;AAYH;AACA,MAAM,6BAA6B,GAAG,oBAAoB;AAa1D,UAAU,CAAC,wBAAwB,GAAG,CAAC,EACrC,UAAU,GAGX,KAAI;AACH,IAAA,MAAM,kBAAkB,GAAG,MAAM,CAAC,wBAAwB,CACxD,MAAM,CAAC,cAAc,CAAC,UAAU,CAAC,EACjC,oBAAoB,CACpB,CAAC,GAAI;;AAGP,IAAA,MAAM,CAAC,cAAc,CAAC,UAAU,EAAE,oBAAoB,EAAE;QACtD,GAAG,GAAA;YACD,OAAO,CAAC,GAAG,kBAAkB,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,iBAAiB,CAAC;QAC9D,CAAC;AACF,KAAA,CAAC;;;AAIF,IAAA,MAAM,wBAAwB,GAC5B,UAAU,CAAC,SAAS,CAAC,wBAAwB;IAC/C,UAAU,CAAC,SAAS,CAAC,wBAAwB,GAAG,UAC9C,IAAY,EACZ,GAAkB,EAClB,KAAoB,EAAA;QAEpB,IAAI,IAAI,KAAK,iBAAiB,IAAI,KAAK,KAAK,IAAI,EAAE;AAChD,YAAA,iBAAiB,CAAC,IAAI,CAAC,IAAI,CAAC;QAC9B;QACA,wBAAwB,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,EAAE,GAAG,EAAE,KAAK,CAAC;AACvD,IAAA,CAAC;;;AAID,IAAA,MAAM,iBAAiB,GAAG,UAAU,CAAC,SAAS,CAAC,iBAAiB;AAChE,IAAA,UAAU,CAAC,SAAS,CAAC,iBAAiB,GAAG,YAAA;;;QAKvC,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,iBAAiB,CAAC,EAAE;AACzC,YAAA,iBAAiB,CAAC,IAAI,CAAC,IAAI,CAAC;QAC9B;AACF,IAAA,CAAC;;;AAID,IAAA,MAAM,gBAAgB,GAAG,UAAU,CAAC,SAAS,CAAC,gBAAgB;AAC9D,IAAA,UAAU,CAAC,SAAS,CAAC,gBAAgB,GAAG,YAAA;AACtC,QAAA,IAAI,IAAI,CAAC,UAAU,EAAE;AACnB,YAAA,IAAI,CAAC,gBAAgB,GAAG,IAAI;YAC5B,OAAO,IAAI,CAAC,UAAU;QACxB;aAAO;AACL,YAAA,OAAO,gBAAgB,CAAC,IAAI,CAAC,IAAI,CAAC;QACpC;AACF,IAAA,CAAC;;AAGD,IAAA,MAAM,MAAM,GAAG,MAAM,CAAC,cAAc,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC,MAAM;AACjE,IAAA,UAAU,CAAC,SAAS,CAAC,MAAM,GAAG,UAE5B,iBAAiC,EAAA;AAEjC,QAAA,MAAM,KAAK,GAAG,IAAI,CAAC,MAAM,EAAE;;;AAG3B,QAAA,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,iBAAiB,CAAC;AACpC,QAAA,IAAI,IAAI,CAAC,gBAAgB,EAAE;AACzB,YAAA,IAAI,CAAC,gBAAgB,GAAG,KAAK;;YAE7B,KAAK,MAAM,QAAQ,IAAI,IAAI,CAAC,iBAAiB,EAAE,EAAE;AAC/C,gBAAA,IAAI,QAAQ,CAAC,UAAU,CAAC,6BAA6B,CAAC,EAAE;oBACtD,MAAM,QAAQ,GAAG,QAAQ,CAAC,KAAK,CAAC,6BAA6B,CAAC,MAAM,CAAC;AACrE,oBAAA,IAAI,CAAC,eAAe,CAAC,QAAQ,CAAC;AAC9B,oBAAA,IAAI,CAAC,eAAe,CAAC,QAAQ,CAAC;gBAChC;YACF;YACA,OAAO,CAAC,KAAK,EAAE,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,aAAa,CAAC;QACrD;aAAO;YACL,MAAM,CAAC,KAAK,EAAE,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,aAAa,CAAC;QACpD;AACF,IAAA,CAAC;AACH,CAAC"}